<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="favicon.ico" rel="icon">
    <title>MPG-Recast</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            animation: float 20s infinite linear;
        }

        /* Styles pour les onglets */
        .tabs-container {
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-x: auto;
        }

        .tab-button {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
        }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .league-selector {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 2px solid #dee2e6;
        }

        .league-selector-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .league-selector label {
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
        }

        .league-selector input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .league-selector input:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .league-selector button {
            padding: 10px 25px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .league-selector button:hover {
            background: linear-gradient(135deg, #2980b9, #21618c);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .league-selector button:active {
            transform: translateY(0);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .classement-table {
            width: 99%;
            border-collapse: collapse;
            margin: 0;
            background: white;
        }

        .classement-table th,
        .classement-table td {
            padding: 10px;
            text-align: left;
            /* border-bottom: 1px solid #e0e0e0; */
        }

        .classement-table th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .classement-table tr:hover {
            background: #f0f8ff;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .position {
            font-weight: bold;
            font-size: 1.2em;
            width: 60px;
            text-align: center;
        }

        .position.first {
            color: #ffd700;
        }

        .position.second {
            color: #c0c0c0;
        }

        .position.third {
            color: #cd7f32;
        }

        .joueur-name {
            font-weight: 600;
            color: #2c3e50;
            /* text-align: left; */
        }

        .points {
            font-weight: bold;
            color: #27ae60;
            font-size: 1.1em;
        }

        .badge {
            display: inline-block;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .classement-table th,
            .classement-table td {
                padding: 10px 8px;
                font-size: 0.9em;
            }
        }

        .divisions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .division h2 {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        @media (max-width: 900px) {
            .divisions {
                grid-template-columns: 1fr;
            }

            .classement-table th,
            .classement-table td {
                font-size: 0.85em;
                padding: 10px 6px;
            }

            .position {
                font-size: 1em;
            }

            .league-selector-content {
                flex-direction: column;
                align-items: stretch;
            }

            .league-selector input,
            .league-selector button {
                width: 100%;
            }

        }

        .division {
            overflow-x: auto;
        }

        .expanded-row {
            animation: slideDown 2s ease;
            background: #bdc279;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .legend-table {
            width: 48%;
            overflow-x: auto; /* Au cas où le contenu déborde quand même */
        }

        .legend-table th,
        .legend-table td {
            padding: 10px 5px;
            text-align: center;
            vertical-align: middle;
        }

        /* Aligner les SVG avec le texte */
        .legend-table td > div {
            display: flex;
            justify-content: center; /* Centrage horizontal */
            gap: 8px; /* Espacement entre SVG et texte */
        }

        .legend-table svg {
            flex-shrink: 0; /* Empêche le SVG de rétrécir */
        }

        @media (max-width: 900px) {
            .header h1 {
                font-size: 1.8em;
            }

            .divisions {
                grid-template-columns: 1fr;
            }

            .classement-table th,
            .classement-table td {
                font-size: 0.85em;
                padding: 10px 6px;
            }

            .position {
                font-size: 1em;
            }

            .tab-button {
                min-width: 120px;
                padding: 12px 15px;
                font-size: 0.9em;
            }
        }


        /* Navigation par journée */
        .journee-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .journee-navigation button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .journee-navigation button:hover:not(:disabled) {
            background: linear-gradient(135deg, #2980b9, #21618c);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .journee-navigation button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .journee-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .journee-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .journee-dates {
            font-size: 0.9em;
            color: #666;
        }

        /* Conteneur des matchs */
        .matches-container {
            padding: 20px;
        }

        .match-date-group {
            margin-bottom: 30px;
        }

        .match-date-header {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            padding: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .match-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .match-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .match-time {
            font-weight: bold;
            color: #3498db;
            min-width: 60px;
        }

        .match-teams {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .team-name {
            font-weight: 600;
            color: #2c3e50;
            min-width: 150px;
            text-align: center;
        }

        .match-score {
            font-size: 1.2em;
            font-weight: bold;
            color: #27ae60;
            min-width: 60px;
            text-align: center;
        }

        .match-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-avenir {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-termine {
            background: #e8f5e9;
            color: #388e3c;
        }

        .loadingCal {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .match-card {
                flex-direction: column;
                gap: 10px;
            }

            .team-name {
                min-width: auto;
            }

            .journee-navigation {
                flex-wrap: wrap;
            }
        }        
    </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9LJB9V4E62"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9LJB9V4E62');
</script>

<body>
    <div class="container">
        <div class="header"
            style="align-items: center;justify-content: center;gap: 20px;padding: 15px 30px;background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <table style="width: 100%;">
                <td style="width: 10%;">
                    <a href="https://ligue1.com/fr/competitions/ligue1mcdonalds?tab=standings" target="_blank" rel="noopener noreferrer">
                        <img src="https://ligue1.com/images/Logo_Ligue1.webp" style="width: 70%" />
                    </a>
                </td>
                <td>
                    <h1 id="leagueTitle"></h1>
                </td>
                <td style="width: 10%;">
                    <a href="https://www.monpetitgazon.com/" target="_blank" rel="noopener noreferrer">
                        <img src="https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/110825_mpg_2_56f655b391.webp" style="width: 70%" />
                    </a>
                </td>
            </table>
        </div>

        <!-- Navigation par onglets -->
        <div class="tabs-container">
            <ul class="tabs">
                <li><button class="tab-button active" data-tab="classement">📊 Classement</button></li>
                <li><button class="tab-button" data-tab="calendrier">📅 Calendrier</button></li>
                <!-- <li><button class="tab-button" data-tab="stats">📈 Statistiques</button></li> -->
                <!-- <li><button class="tab-button" data-tab="equipes">👥 Équipes</button></li> -->
                <li><button class="tab-button" data-tab="cfg">⚙️ Configuration</button></li>
            </ul>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            Chargement des données...
        </div>

        <div id="error" class="error" style="display: none;">
            Erreur lors du chargement des données. Veuillez réessayer.
        </div>

        <div id="content" style="display: none;">
            <!-- Onglet Classement -->
            <div id="classement-tab" class="tab-content active">
                <div class="divisions">
                    <div id="div1" class="division">
                        <h2 id="divisionTitle1"></h2>
                        <table id="division1" class="classement-table">
                            <!-- Table headers + body -->
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Equipe</th>
                                    <th>Points</th>
                                    <th style="text-align: center">J</th>
                                    <th style="text-align: center">V/N/D</th>
                                    <th style="text-align: center">Diff.</th>
                                    <th style="text-align: center">Buts<br>réels</th>
                                    <th style="text-align: center">Buts<br>MPG</th>
                                    <th style="text-align: center">Derniers<br>matchs</th>
                                </tr>
                            </thead>
                            <tbody id="classementBodyDiv1"></tbody>
                        </table>
                    </div>
                    <div id="div2" class="division">
                        <h2 id="divisionTitle2"></h2>
                        <table id="division2" class="classement-table">
                            <!-- Table headers + body -->
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Equipe</th>
                                    <th>Points</th>
                                    <th style="text-align: center">J</th>
                                    <th style="text-align: center">V/N/D</th>
                                    <th style="text-align: center">Diff.</th>
                                    <th style="text-align: center">Buts<br>réels</th>
                                    <th style="text-align: center">Buts<br>MPG</th>
                                    <th style="text-align: center">Derniers<br>matchs</th>
                                </tr>
                            </thead>
                            <tbody id="classementBodyDiv2"></tbody>
                        </table>
                    </div>
                    <div id="legende">
                        <div>Derniers matchs</div>
                        <div>
                            <table class="legend-table">
                                <tr>
                                    <td>
                                        <div style="display: flex;">
                                            <div aria-labelledby="l5l-w">
                                                <svg aria-hidden="true" viewBox="0 0 22 22"
                                                    style="height: 22px; width: 22px">
                                                    <path d="M11 3a8 8 0 1 1 0 16 8 8 0 0 1 0-16"
                                                        fill="#34A853"></path>
                                                    <path
                                                        d="M9.2 12.28 7.12 10.2 6 11.32l3.2 3.2 6.4-6.4L14.48 7z"
                                                        fill="#fff"></path>
                                                </svg>
                                            </div>
                                            <div id="l5l-w">Victoire</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display: flex;">
                                            <div aria-labelledby="l5l-t">
                                                <svg aria-hidden="true" viewBox="0 0 22 22"
                                                    style="height: 22px; width: 22px">
                                                    <path clip-rule="evenodd"
                                                        d="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16"
                                                        fill="#9D9BA7" fill-rule="evenodd"></path>
                                                    <path clip-rule="evenodd" d="M8 10h6v2H8z" fill="#fff" fill-rule="evenodd"></path>
                                                </svg>
                                            </div>
                                            <div id="l5l-t">Nul</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display: flex;">
                                            <div aria-labelledby="l5l-l">
                                                <svg aria-hidden="true" viewBox="0 0 22 22"
                                                    style="height: 22px; width: 22px">
                                                    <path clip-rule="evenodd"
                                                        d="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16"
                                                        fill="#EA4335" fill-rule="evenodd"></path>
                                                    <path clip-rule="evenodd"
                                                        d="M13.263 14.394 11 12.131l-2.263 2.263-1.131-1.131L9.869 11 7.606 8.737l1.131-1.131L11 9.869l2.263-2.263 1.131 1.131L12.131 11l2.263 2.263z"
                                                        fill="#fff" fill-rule="evenodd"></path>
                                                </svg>
                                            </div>
                                            <div id="l5l-l">Défaite</div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Équipes -->
            <div id="equipes-tab" class="tab-content">
                <div style="padding: 40px; text-align: center;">
                    <h2>Équipes</h2>
                    <p style="margin-top: 20px; color: #666;">Contenu à venir...</p>
                </div>
            </div>

            <!-- Onglet Calendrier -->
            <div id="calendrier-tab" class="tab-content">
                <div style="padding: 40px; text-align: center;">
                    <!-- <h2>Calendrier</h2> -->
                    <!-- <p style="margin-top: 20px; color: #666;">Contenu à venir...</p> -->
                    <div id="cal">
                        <div class="journee-navigation">
                            <button id="prevBtn" onclick="changeJournee(-1)">
                                <
                            </button>
                            
                            <div class="journee-info">
                                <div class="journee-number">Journée <span id="currentJournee">9</span></div>
                                <div class="journee-dates" id="journeeDates"></div>
                            </div>
                            
                            <button id="nextBtn" onclick="changeJournee(1)">
                                >
                            </button>
                        </div>

                        <div id="loadingCal" class="loadingCal">
                            <div class="spinner"></div>
                            Chargement des matchs...
                        </div>

                        <div id="matchesContainer" class="matches-container" style="display: none;">
                            <!-- Les matchs seront affichés ici -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Statistiques -->
            <div id="stats-tab" class="tab-content">
                <div style="padding: 40px; text-align: center;">
                    <h2>Statistiques</h2>
                    <p style="margin-top: 20px; color: #666;">Contenu à venir...</p>
                </div>
            </div>

            <!-- Onglet Configuration -->
            <div id="cfg-tab" class="tab-content">
                <div style="padding: 40px; text-align: center;">
                    <h3>Saisir le code d'une ligue pour afficher le classement de ses 2 premières divisions dans l'onglet dédié.</h3>
                    <div class="league-selector">
                        <form id="leagueForm" class="league-selector-content">
                            <label for="leagueCodeInput">Code de la ligue</label>
                            <input 
                                type="text" 
                                id="leagueCodeInput" 
                                placeholder="Ex: PNAL4RJN" 
                                defaultValue="PNAL4RJN"
                                maxlength="8"
                                pattern="[A-Za-z0-9]{8}"
                                title="Le code de ligue doit contenir 8 caractères alphanumériques"
                            />
                            <button type="submit">Charger</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    let codeLeague = "PNAL4RJN";
    let seasonNum = "9";
    let nbPlayers = 8;

    let currentJournee = 1;
    const totalJournees = 34; // Nombre total de journées en Ligue 1
    let allMatches = [];

    let API_URL_LEAGUE = 'https://api.mlnstats.com/mpgleague/league/' + codeLeague;

    let codeLeagueAndSeasonNum = codeLeague + '_' + seasonNum;
    let API_URL_DIV_1 = 'https://api.mpgstats.fr/mpgleague/matches/' + codeLeagueAndSeasonNum + "_1";
    let API_URL_DIV_2 = 'https://api.mpgstats.fr/mpgleague/matches/' + codeLeagueAndSeasonNum + "_2";

    const ringElement = '<span class="badge"><img src="./img/ring.png" style="vertical-align: bottom; width: 20px"/></span>';

    // Gestion des onglets
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            button.classList.add('active');
            document.getElementById(tabId + '-tab').classList.add('active');
        });
    });


    // Charger les données au démarrage
    async function loadMatches() {
        try {
            const response = await fetch('https://proxy-football-api.onrender.com/api/matches');
            const data = await response.json();
            allMatches = data?.matches || [];

            // Chercher la première journée avec des matchs non joués
            const firstUnplayed = allMatches.find(match => match.status !== 'FINISHED');
            currentJournee = firstUnplayed ? firstUnplayed.matchday : 1;
            displayJournee(currentJournee);
        } catch (error) {
            console.error('Erreur de chargement:', error);
            document.getElementById('loadingCal').innerHTML = 
                '<p style="color: #e74c3c;">Erreur lors du chargement des données</p>';
        }
    }

    // Fonction pour changer de journée
    function changeJournee(direction, event) {
        const newJournee = currentJournee + direction;
        
        if (newJournee < 1 || newJournee > totalJournees) {
            return;
        }
        
        currentJournee = newJournee;
        displayJournee(currentJournee);
        updateNavigationButtons();
    }

    // Afficher une journée spécifique
    function displayJournee(journeeNum) {
        document.getElementById('loadingCal').style.display = 'block';
        document.getElementById('matchesContainer').style.display = 'none';
        
        // Simuler un délai de chargement
        setTimeout(() => {
            const journees = allMatches.filter(j => j.matchday === journeeNum);
            if (!journees || journees.length === 0) {
                document.getElementById('matchesContainer').innerHTML = 
                    '<p style="text-align: center; padding: 40px;">Aucun match disponible pour cette journée</p>';
            } else {
                renderMatches(journees);
            }
            
            document.getElementById('currentJournee').textContent = journeeNum;
            updateJourneeDates(journees);
            document.getElementById('loadingCal').style.display = 'none';
            document.getElementById('matchesContainer').style.display = 'block';
            
            updateNavigationButtons();
        }, 300);
    }

    // Mettre à jour les dates de la journée
    function updateJourneeDates(journeeData) {
        const datesDiv = document.getElementById('journeeDates');
        if (journeeData && journeeData.dates) {
            const startDate = new Date(journeeData.dates.start).toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'short' 
            });
            const endDate = new Date(journeeData.dates.end).toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'short',
                year: 'numeric'
            });
            datesDiv.textContent = `${startDate} - ${endDate}`;
        }
    }

    // Afficher les matchs
    function renderMatches(journees) {
        const container = document.getElementById('matchesContainer');
        container.innerHTML = '';
        
        // Grouper les matchs par date
        const matchesByDate = {};
        journees.forEach(match => {
            const dateKey = match.utcDate;
            if (!matchesByDate[dateKey]) {
                matchesByDate[dateKey] = [];
            }
            matchesByDate[dateKey].push(match);
        });
        
        // Afficher chaque groupe de date
        Object.entries(matchesByDate).forEach(([date, matches]) => {
            const dateGroup = document.createElement('div');
            dateGroup.className = 'match-date-group';
            
            const dateHeader = document.createElement('div');
            dateHeader.className = 'match-date-header';
            
            dateHeader.textContent = new Date(date).toLocaleDateString('fr-FR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            dateGroup.appendChild(dateHeader);
            
            matches.forEach(match => {
                const matchCard = createMatchCard(match);
                dateGroup.appendChild(matchCard);
            });
            
            container.appendChild(dateGroup);
        });
    }

    // Créer une carte de match
    function createMatchCard(match) {
        const card = document.createElement('div');
        card.className = 'match-card';
        
        const time = new Date(match.utcDate).toLocaleTimeString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const statusClass = match.status === 'FINISHED' ? 'status-termine' : 'status-avenir';
        const statusText = match.status === 'FINISHED' ? 'Terminé' : 'À venir';
        
        card.innerHTML = `
            <div class="match-time">${time}</div>
            <div class="match-teams">
                <div class="team-name">${match.homeTeam.name}</div>
                <div class="match-score">${match.score.fullTime.home ?? ''} - ${match.score.fullTime.away ?? ''}</div>
                <div class="team-name">${match.awayTeam.name}</div>
            </div>
            <span class="match-status ${statusClass}">${statusText}</span>
        `;
        
        return card;
    }

    // Mettre à jour l'état des boutons de navigation
    function updateNavigationButtons() {
        document.getElementById('prevBtn').disabled = currentJournee <= 1;
        document.getElementById('nextBtn').disabled = currentJournee >= totalJournees;
    }

    // Variable pour suivre la ligne actuellement étendue
    let currentExpandedRowId = null;

    let mapBonusTargeted = new Map();
    let mapBonusPlayed = new Map();
    let expandableTables = [];

    // Classe pour gérer le tableau extensible
    class ExpandableTable {
        constructor(containerId, divisionTitleId, data) {
            this.container = document.getElementById(containerId);
            this.divisionTitleId = divisionTitleId;
            this.data = data;
            this.clickHandler = null; // Référence à l'écouteur de clic
            this.init();
        }

        init() {
            this.render();
            this.attachEventListeners();
        }

        // Méthode pour nettoyer le composant
        destroy() {
            // Fermer la ligne étendue si elle existe
            if (currentExpandedRowId) {
                this.closeExpandedRow(currentExpandedRowId);
            }
            
            // Supprimer les écouteurs d'événements
            if (this.clickHandler) {
                this.container.removeEventListener('click', this.clickHandler);
                this.clickHandler = null;
            }
            
            // Vider le contenu
            if (this.container) {
                this.container.innerHTML = '';
            }
            
            const divisionTitle = document.getElementById(this.divisionTitleId);
            if (divisionTitle) {
                divisionTitle.innerHTML = '';
            }
            
            // Libérer les références
            this.container = null;
            this.divisionTitleId = null;
            this.data = null;
        }

        render() {
            // Personnalisation du nom de la division
            const divisionTitle = document.getElementById(this.divisionTitleId);
            divisionTitle.innerHTML = '';
            const divisionSpan = document.createElement('span');
            divisionSpan.innerHTML = `<p>${this.data.name}</p>`;
            divisionTitle.appendChild(divisionSpan);

            this.container.innerHTML = '';

            this.data.teams.forEach((mpgTeam, index) => {
                this.container.appendChild(this.createDataRow(mpgTeam, index));
            });
        }

        createDataRow(mpgTeam, index) {
            const position = index + 1;
            let positionClass = '';

            const wdl = mpgTeam.win + '/' + mpgTeam.draw + '/' + mpgTeam.loss;
            const realGoals = formatGP(mpgTeam.realGP) + '/' + formatGC(mpgTeam.realGC)
            const mpgGoals = formatGP(mpgTeam.MPGGP) + '/' + formatGC(mpgTeam.MPGGC);
            const playerName = farmersPlayers().get(mpgTeam.MPGuserId) || 'Inconnu';
        
            // Construire une liste des bonus utilisés par le joueur
            const bonusFormates = formatBonusTitle(mpgTeam.bonusTab);

            // Gestion de l'anneau, extraction de la dernière journée de championnat sans modifier l'original
            let ring = '';
            const lastTimeline = [...mpgTeam.timeline].pop();
            if (lastTimeline.P === 1) {
                ring = ringElement;
            }

            // TODO : En attente d'évolution de l'API MPGStats pour récupérer la variation de position
            // Gestion de la variation de position
            let variation = "";
            // if ([4, 5, 6].includes(position)) {
            //     variation = '<img src="https://assets.eurosport.io/web/inArenaIcons/table-down.svg" style="width: 15px;"/>'
            // } else if ([3].includes(position)) {
            //     variation = '<img src="https://assets.eurosport.io/web/inArenaIcons/table-up.svg" style="width: 15px;"/>';
            // }

            // Gestion du classement
            if (position === 1) {
                positionClass = 'first';
            } else if (position === 2) {
                positionClass = 'second';
            } else if (position === 3) {
                positionClass = 'third';
            }

            const tr = document.createElement('tr');
            tr.className = 'data-row';
            tr.setAttribute('data-row-id', mpgTeam.id);

            const numDivision = this.data.divisionNum;
            const nbJoueurs = this.data.teams.length;

            // Mise en évidence des leaders de la division (permier de la première division ou top 3 des autres divisions)
            if ((numDivision !== 1 && position < 4) || position === 1) {
                tr.style.backgroundColor = 'rgba(0, 255, 0, 0.1)';
            }
            // Mise en évidence des derniers de la division (dernier de la dernière division ou bottom 3 des autres divisions)
            else if (numDivision === 1 && (position > nbJoueurs - 3) || position === nbJoueurs) {
                tr.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
            }

            // Résultats des dernières journées
            const lastFiveMatches = document.createElement('div');
            const lastFiveMatchesChild = document.createElement('div');
            lastFiveMatchesChild.style.display = 'inline-flex';
            lastFiveMatches.appendChild(lastFiveMatchesChild);

            mpgTeam.timeline
                .slice(-5)  // Garder uniquement les 5 derniers éléments
                .forEach((day, index) => {
                    // Sommer les buts réels marqués
                    let butsGP = day.G?.flatMap(obj => Object.values(obj))
                        .reduce((a, b) => a + b, 0) || 0;
                    // Ajouter les buts MPG
                    butsGP += day.M?.length || 0;

                    // Somme des buts encaissés
                    const butsGC = (day.g || 0) + (day.m || 0);

                    // Construction du titre de l'icône
                    let titleDay;
                    if (day.S === 'H') {
                        // Match à domicile 'Home'
                        titleDay = `${farmersPlayersId().get(mpgTeam.id) || 'Inconnu'} ${butsGP} - ${butsGC} ${farmersPlayersId().get(day.o) || 'Inconnu'}`;
                    } else {
                        // Match à l'extérieur 'Away'
                        titleDay = `${farmersPlayersId().get(day.o) || 'Inconnu'} ${butsGC} - ${butsGP} ${farmersPlayersId().get(mpgTeam.id) || 'Inconnu'}`;
                    }

                    switch (day.r) {
                        case 'W': lastFiveMatchesChild.appendChild(createSuccessIconElement(titleDay)); break;
                        case 'D': lastFiveMatchesChild.appendChild(createNulIconElement(titleDay)); break;
                        case 'L': lastFiveMatchesChild.appendChild(createDefeatIconElement(titleDay)); break;
                    }
                });

            const nbMissingTimelines = 5 - mpgTeam.timeline.length;
            Array.from({ length: nbMissingTimelines }, () => {
                lastFiveMatchesChild.appendChild(createNotPlayedIconElement());
            });

            const listeBonus = bonusList();

            mpgTeam.timeline.forEach((day, index) => {
                const opponent = farmersPlayersId().get(day.o) || 'Inconnu';

                // Filtrer les bonus non pertinents (0 : Capitaine, 6 : Chapron, 8 : 4 défenseurs, 9 : 5 défenseurs)
                const idxBonus = day?.b?.filter(bonus => ![0, 6, 8, 9].includes(bonus)).flatMap(bonus => bonus);

                // Construire une map des bonus ciblés pour chaque opposant
                const keyOpponentId = day.o;

                if (idxBonus && idxBonus.length === 1) {
                    const existingData = mapBonusTargeted.get(keyOpponentId) || [];
                    mapBonusTargeted.set(keyOpponentId, [...existingData, {nom : farmersPlayersId().get(mpgTeam.id) ?? 'Inconnu', bonus: idxBonus, day: index + 1}]);

                    const existingDataPlayed = mapBonusPlayed.get(mpgTeam.id) || [];
                    const detail = listeBonus[idxBonus[0]];
                    mapBonusPlayed.set(mpgTeam.id, [...existingDataPlayed, {adversaire : opponent, bonus: idxBonus[0], day: index + 1, info: detail}]);
                } else {
                    mapBonusTargeted.set(keyOpponentId, mapBonusTargeted.get(keyOpponentId) || []);
                    mapBonusPlayed.set(mpgTeam.id, mapBonusPlayed.get(mpgTeam.id) || []);
                }
            });

            tr.innerHTML = `
                <td class="position ${positionClass}"><span>${position}${variation}</span></td>
                <td class="joueur-name" title="${bonusFormates}">${mpgTeam.name} ${ring}<br><span style="font-size: 80%;">${playerName}</span></td>
                <td class="points">${mpgTeam.points} pts</td>
                <td style="text-align: center">${this.data.leagueDayScan}</td>
                <td style="text-align: center">${wdl}</td>
                <td style="text-align: center">${mpgTeam.goalAvg}</td>
                <td style="text-align: center">${realGoals}</td>
                <td style="text-align: center">${mpgGoals}</td>
                <td style="text-align: center">${lastFiveMatches.innerHTML}</td>
            `;
            return tr;
        }

        createExpandedRow(mpgUser) {
            const tr = document.createElement('tr');
            tr.className = 'expanded-row';
            tr.setAttribute('data-expanded-id', mpgUser.id);

            const td = document.createElement('td');
            td.colSpan = 9; // Nombre de colonnes dans le tableau principal																																							

            td.innerHTML = `
                <div class="details-panel" style="display: inline-flex">
                    <h4>Informations du joueur ${mpgUser.name} (${mpgUser.abbr})</h4>
            `;

            const nbBonusDefault = Array.from(bonusDetails().entries()).map(([nom, [description, compteur]]) => compteur).reduce((a, b) => a + b, 0);   
            const bonusCount = getBonusCountUpdated(mpgUser.bonusTab);
            const availableBonuses = Array.from(bonusCount.entries()).filter(([nom, [description, compteur]]) => compteur > 0);
            const nbAvailableBonuses = availableBonuses.map(([nom, [description, compteur]]) => compteur).reduce((a, b) => a + b, 0);
            
            let tableHTML = '<table><tr>';

            if (nbAvailableBonuses > 0) {
            tableHTML += `
                    <td style="vertical-align: top; padding-right: 16px;">
                        <div>Bonus disponible${nbAvailableBonuses > 1 ? "s" : ""} (${nbAvailableBonuses}/${nbBonusDefault})</div>
                        <div id="dispos" style="display: inline-flex; margin-right: 16px;">
                            ${availableBonuses.map(([nom, [description, compteur, linkImg]]) => `
                                <div style="display: inline-flex; align-items: center; gap: 8px; margin: 4px; vertical-align: middle;">
                                    ${Array.from({ length: compteur }, 
                                        () => `<img title="${description}" src="${linkImg}" width="36.8" height="48" style="vertical-align: middle;">`).join('')}
                                </div>
                            `).join('')}
                        </div>
                    </td>
                    `;
            }

            const bonusPlayed = Array.from(mapBonusPlayed.get(mpgUser.id));
            const nbBonusPlayed = bonusPlayed.length;

            if (nbBonusPlayed > 0) {
                tableHTML += `
                        <td style="vertical-align: top; padding-right: 16px;">
                            <div>Bonus utilisé${nbBonusPlayed > 1 ? "s" : ""} (${nbBonusPlayed}/${nbBonusDefault})</div>
                            <div id="used" style="display: inline-flex; margin-right: 16px;">
                                ${bonusPlayed.map((element) => `
                                    <div style="display: inline-flex; align-items: center; gap: 8px; margin: 4px; vertical-align: middle;">
                                        ${Array.from({ length: 1 },
                                            () => `<img title="${element.info[1]} : contre ${element.adversaire} (J${element.day})" src="${element.info[2]}" width="36.8" height="48" style="vertical-align: middle;">`).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </td>
                        `;
            }

            tableHTML += `</td></tr></table>`;
            td.innerHTML += tableHTML;

            const bonusTargeted = mapBonusTargeted.get(mpgUser.id);
                
            if (bonusTargeted?.length > 0) {   
                let tableHTML = '<table><tr>';
                
                const targetBonus = Array.from(getBonusTargeted(bonusTargeted));

                // Trier les bonus par journée de championnat
                targetBonus.sort((a, b) => a[1][3].day - b[1][3].day);
                let nbBonusTarget = bonusTargeted.length

                tableHTML += `
                        <td style="vertical-align: top; padding-right: 16px;">
                            <div>Bonus encaissé${nbBonusTarget > 1 ? "s" : ""} (${nbBonusTarget})</div>
                            <div id="used" style="display: inline-flex; margin-right: 16px;">
                                ${targetBonus.map(([nom, [bKey, libelle, linkImg, tmp]]) => `
                                    <div style="display: inline-flex; align-items: center; gap: 8px; margin: 4px; vertical-align: middle;">
                                        ${Array.from({ length: 1 }, 
                                            () => `<img title="${libelle} : attaque de ${tmp.nom} (J${tmp.day})" src="${linkImg}" width="36.8" height="48" style="vertical-align: middle;">`).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </td>`;

                tableHTML += `</tr></table>`;
                td.innerHTML += tableHTML
            }

            td.innerHTML += `
                        <div>Classement général moyen : Points ${mpgUser.gScoreAvg} / Rang ${mpgUser.gRankAvg}</div>
                    </div>
                </div>
            `;

            tr.appendChild(td);
            return tr;
        }

        attachEventListeners() {
            // Créer une référence à la fonction handler pour pouvoir la supprimer plus tard
            this.clickHandler = (e) => {
                e.preventDefault();
                const dataRow = e.target.closest('.data-row');
                if (dataRow) {
                    const rowId = parseInt(dataRow.getAttribute('data-row-id'));
                    this.handleRowClick(rowId, dataRow);
                }
            };
            // Attacher l'événement avec la référence stockée
            this.container.addEventListener('click', this.clickHandler);}

        handleRowClick(rowId, rowElement) {
            // Fermer la ligne actuellement étendue si elle existe et est différente
            if (currentExpandedRowId && currentExpandedRowId !== rowId) {
                this.closeExpandedRow(currentExpandedRowId);
            }

            // Vérifier si la ligne cliquée est déjà étendue
            const existingExpandedRow = document.querySelector(`[data-expanded-id="${rowId}"]`);

            if (existingExpandedRow) {
                // Fermer la ligne étendue
                this.closeExpandedRow(rowId);
                currentExpandedRowId = null;
            } else {
                const mpgTeam = this.data.teams.find(item => item.id === rowId);
                if (!mpgTeam) {
                    console.error('Équipe non trouvée pour l\'ID:', rowId);
                    return;
                }
                // Ouvrir la nouvelle ligne étendue
                const expandedRow = this.createExpandedRow(mpgTeam);
                rowElement.after(expandedRow);
                rowElement.classList.add('expanded');
                currentExpandedRowId = rowId;
            }
        }

        closeExpandedRow(rowId) {
            const expandedRow = document.querySelector(`[data-expanded-id="${rowId}"]`);
            const dataRow = document.querySelector(`[data-row-id="${rowId}"]`);

            if (expandedRow) {
                expandedRow.classList.add('fadeOut');
                setTimeout(() => {
                    expandedRow.remove();
                    if (dataRow) {
                        dataRow.classList.remove('expanded');
                    }
                }, 200);
            }
        }

        // Méthodes utilitaires pour ajouter/supprimer des lignes
        addRow(newRowData) {
            this.data.push(newRowData);
            this.render();
            this.attachEventListeners();
        }

        removeRow(rowId) {
            this.data = this.data.filter(item => item.id !== rowId);
            this.closeExpandedRow(rowId);
            this.render();
            this.attachEventListeners();
        }

        updateRow(rowId, newData) {
            const index = this.data.findIndex(item => item.id === rowId);
            if (index !== -1) {
                this.data[index] = { ...this.data[index], ...newData };
                this.render();
                this.attachEventListeners();
            }
        }
    }

    const createNotPlayedIconElement = (labelId = 'validation-notplayed') => {
        const div = document.createElement('div');
        div.setAttribute('aria-labelledby', labelId);
        div.innerHTML = `
            <svg aria-hidden="true" viewBox="0 0 22 22" style="height: 22px; width: 22px">
                <path d="M18 11a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z" fill="none" stroke="#9D9BA7" stroke-width="2"></path>
            </svg>`;
        return div;
    };

    const createSuccessIconElement = (title) => {
        const labelId = 'validation-success'
        const div = document.createElement('div');
        div.setAttribute('aria-labelledby', labelId);
        div.innerHTML = `
        <span title="${title}">
            <svg aria-hidden="true" viewBox="0 0 22 22" style="height: 22px; width: 22px">
                <path clip-rule="evenodd" d="M11 3a8 8 0 1 1 0 16 8 8 0 0 1 0-16" fill="#34A853"></path>
                <path clip-rule="evenodd" d="M9.2 12.28 7.12 10.2 6 11.32l3.2 3.2 6.4-6.4L14.48 7z" fill="#fff"></path>
            </svg>
        </span>`;
        return div;
    };

    const createNulIconElement = (title) => {
        const labelId = 'validation-nul';
        const div = document.createElement('div');
        div.setAttribute('aria-labelledby', labelId);
        div.innerHTML = `
        <span title="${title}">
            <svg aria-hidden="true" viewBox="0 0 22 22" style="height: 22px; width: 22px">  
                <path clip-rule="evenodd" d="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16" fill="#9D9BA7" fill-rule="evenodd"></path> 
                <path clip-rule="evenodd" d="M8 10h6v2H8z" fill="#fff" fill-rule="evenodd"></path>  
            </svg>
        </span>`;
        return div;
    };

    const createDefeatIconElement = (title) => {
        const labelId = 'validation-defeat';
        const div = document.createElement('div');
        div.setAttribute('aria-labelledby', labelId);
        div.innerHTML = `
        <span title="${title}">
            <svg aria-hidden="true" viewBox="0 0 22 22" style="height: 22px; width: 22px">  
                <path clip-rule="evenodd" d="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16" fill="#EA4335" fill-rule="evenodd"></path> 
                <path clip-rule="evenodd" d="M13.263 14.394 11 12.131l-2.263 2.263-1.131-1.131L9.869 11 7.606 8.737l1.131-1.131L11 9.869l2.263-2.263 1.131 1.131L12.131 11l2.263 2.263z" fill="#fff" fill-rule="evenodd"></path>  
            </svg>
        </span>`;
        return div;
    };

    async function fetchJson(url) {
        const resp = await fetch(url);
        if (!resp.ok) {
            console.error(url, ' -> Erreur HTTP ' + resp.status);
            return null;
        } else {
            return resp.json();
        }
    }

    async function fetchLeague() {
        try {
            const response = await fetch(API_URL_LEAGUE);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if(data?.error === 'championshipNotManaged') {
                throw new Error('Championnat non géré par la source de données.');
            }
            else if(data?.error === 'notFetchable') {
                throw new Error('Ligue non trouvée. Vérifiez le code de la ligue.');
            } else {
                displayLeague(data);
            }
        } catch (error) {
            contentDisplay(); // Afficher le contenu même en cas d'erreur
            showError(`Impossible de charger les données de la ligue : ${error.message}`);
            throw error; // Rejeter la promesse pour indiquer l'échec
        }
    }

    function displayLeague(data) {
        // Affichage de la ligue
        const leagueTitle = document.getElementById('leagueTitle');
        leagueTitle.innerHTML = '';
        const spanELement = document.createElement('span');
        spanELement.innerHTML = `<p>${data.name} / Saison ${data.seasonNum}</p>`;
        leagueTitle.appendChild(spanELement);

        seasonNum = data?.seasonNum?.toString() || "1";
        updateApiUrls();        
    }

    function loadLeague(newLeagueCode) {
        if (!newLeagueCode || newLeagueCode.trim() === '') {
            showError('Veuillez entrer un code de ligue valide.');
            return;
        }

        nbPlayers = 0;
        mapBonusTargeted.clear();
        mapBonusPlayed.clear();
        currentExpandedRowId = null;

        // Nettoyer les anciens composants ExpandableTable
        expandableTables.forEach(table => {
            if (table && typeof table.destroy === 'function') {
                table.destroy();
            }
        });
        expandableTables = [];

        codeLeague = newLeagueCode.trim().toUpperCase();
        updateApiUrls();

        document.getElementById('content').style.display = 'none';
        document.getElementById('error').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        fetchLeague()
            .then(() => {
                // Basculer vers l'onglet Classement
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                const classementTabButton = document.querySelector('.tab-button[data-tab="classement"]');
                classementTabButton.classList.add('active');
                document.getElementById('classement-tab').classList.add('active');

                fetchMatches();
            })
            .catch((error) => {
                console.error('Erreur lors du fetch de la league:', error);
                throw error; // Propager l'erreur pour arrêter le processus
            });
    }

    function updateApiUrls() {
        API_URL_LEAGUE = 'https://api.mlnstats.com/mpgleague/league/' + codeLeague;
        codeLeagueAndSeasonNum = codeLeague + '_' + seasonNum;
        API_URL_DIV_1 = 'https://api.mpgstats.fr/mpgleague/matches/' + codeLeagueAndSeasonNum + "_1";
        API_URL_DIV_2 = 'https://api.mpgstats.fr/mpgleague/matches/' + codeLeagueAndSeasonNum + "_2";
    }

    async function fetchMatches() {
        try {
            const divisionConfigs = [
                [API_URL_DIV_1, 'classementBodyDiv1', 'divisionTitle1', 'division1'],
                [API_URL_DIV_2, 'classementBodyDiv2', 'divisionTitle2', 'division2']
            ];

            const allMatches = await Promise.all(
                divisionConfigs.map(([url]) => fetchJson(url))
            );

            allMatches.forEach((matches, i) => {
                if (!matches) {
                    console.error(`Erreur lors du chargement des matchs pour l'URL: ${divisionConfigs[i][0]}`);

                    let containerId = document.getElementById(divisionConfigs[i][1]);
                    let divisionTitleId = document.getElementById(divisionConfigs[i][2]);
                    divisionTitleId.innerHTML = '<p>Division indisponible</p>';
                    let divisionTable = document.getElementById(divisionConfigs[i][3]);
                    divisionTable.style.display = 'none';
                    return;
                }
                // Il faut supprimer les anciens tableaux avant d'en créer de nouveaux
                let oldContainer = document.getElementById(divisionConfigs[i][1]);
                oldContainer.innerHTML = '';
                oldContainer = document.getElementById(divisionConfigs[i][2]);
                oldContainer.innerHTML = '';

                nbPlayers = matches.division.teams.length;
                expandableTables.push(new ExpandableTable(divisionConfigs[i][1], divisionConfigs[i][2], matches.division));
            });

            contentDisplay();

        } catch (error) {
            console.error('Erreur:', error);
            showError('Erreur lors du chargement des matchs. Vérifiez le code de la ligue.');
        }
    }

    function bonusDetails() {
        const bonusMap = new Map();

        let nbUber = 3;
        let nbSuarez = 1;
        let nbTonton = 1;
        let nbCheat = 1;

        switch(nbPlayers) {
            case 6:
                nbUber = 2;
                nbCheat = 0;
                nbTonton = 0;
                break;
            case 10:
                nbSuarez = 2;
                break;
        }

        bonusMap.set("valise", ["Valise à Nanard", 1, "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/image_c8a2c4971c.png"]);
        bonusMap.set("uber", ["McDo+", nbUber, "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/mcdo_XNSJJIK_7_4d86759c68.png"]);
        bonusMap.set("suarez", ["Suarez", nbSuarez, "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/image_73c40fcf0f.png"]);
        bonusMap.set("zahia", ["Zahia", 1, "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/image_587179007b.png"]);
        bonusMap.set("miroir", ["Miroir", 1, "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/thumbnail_miroir_DPKQOLRY_3fa41cbb7a.png"]);
        bonusMap.set("tonton", ["Tonton Pat'", nbTonton, "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/image_45de0b018a.png"]);
        bonusMap.set("decat", ["4 Decat", 1, "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/image_8b62f75294.png"]);
        bonusMap.set("cheat", ["Cheat Code 18-26", nbCheat, "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/cheat_Code_RQGFVQYS_c1cf552f40.webp"]);
        return Object.freeze(bonusMap);
    }

    function bonusList() {
        const bonus = [];
        bonus.push(["captain", "Capitaine", ""]);
        bonus.push(["valise", "Valise à Nanard", "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/image_c8a2c4971c.png"]);
        bonus.push(["uber", "McDo+", "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/mcdo_XNSJJIK_7_4d86759c68.png"]);
        bonus.push(["suarez", "Suarez", "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/image_73c40fcf0f.png"]);
        bonus.push(["zahia", "Zahia", "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/image_587179007b.png"]);
        bonus.push(["miroir", "Miroir", "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/thumbnail_miroir_DPKQOLRY_3fa41cbb7a.png"]);
        bonus.push(["chapron", "Chapron", ""]);
        bonus.push(["tonton", "Tonton Pat'", "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/image_45de0b018a.png"]);
        bonus.push(["4def", "4 Défenseurs", ""]);
        bonus.push(["5def", "5 Défenseurs", ""]);
        bonus.push(["decat", "4 Decat", "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/image_8b62f75294.png"]);
        bonus.push(["cheat", "Cheat Code 18-26", "https://s3.eu-west-3.amazonaws.com/ligue1.image/cms/cheat_Code_RQGFVQYS_c1cf552f40.webp"]);
        return Object.freeze(bonus);
    }

    function farmersPlayers() {
        const mapPlayerNames = new Map();
        mapPlayerNames.set(188049, "Yannick");
        mapPlayerNames.set(3535140, "Jérôme");
        mapPlayerNames.set(649848, "Vincent");
        mapPlayerNames.set(5142264, "Richard");
        mapPlayerNames.set(3536346, "David");
        mapPlayerNames.set(521473, "Robin");
        mapPlayerNames.set(6429552, "Benoît");
        mapPlayerNames.set(6430884, "Julien");

        mapPlayerNames.set(5892169, "Nicolas");
        mapPlayerNames.set(1497344, "Antoine P.");
        mapPlayerNames.set(1519479, "Jean-Philippe");
        mapPlayerNames.set(6429841, "Stéphane");
        mapPlayerNames.set(7143201, "Charlotte");
        mapPlayerNames.set(7206496, "Leïla");
        mapPlayerNames.set(6942448, "Thomas");
        mapPlayerNames.set(6742055, "Antoine C.");
        return mapPlayerNames;
    }

    function farmersPlayersId() {
        const mapPlayerNames = new Map();
        mapPlayerNames.set(2919624, "Yannick");
        mapPlayerNames.set(2919625, "Jérôme");
        mapPlayerNames.set(2919631, "Vincent");
        mapPlayerNames.set(2919627, "Richard");
        mapPlayerNames.set(2919626, "David");
        mapPlayerNames.set(2919628, "Robin");
        mapPlayerNames.set(2919629, "Benoît");
        mapPlayerNames.set(2919630, "Julien");

        mapPlayerNames.set(2919634, "Nicolas");
        mapPlayerNames.set(2919632, "Antoine P.");
        mapPlayerNames.set(2919633, "Jean-Philippe");
        mapPlayerNames.set(2919635, "Stéphane");
        mapPlayerNames.set(2919638, "Charlotte");
        mapPlayerNames.set(2919639, "Leïla");
        mapPlayerNames.set(2919637, "Thomas");
        mapPlayerNames.set(2919636, "Antoine C.");
        return mapPlayerNames;
    }

    function formatGP(goalGP) {
        return (goalGP > 0 ? '+' : '') + goalGP;
    }

    function formatGC(goalGC) {
        return (goalGC > 0 ? '-' : '') + goalGC;
    }

    function getBonusCountUpdated(bonusTab) {

        const detailsBonus = bonusDetails();

        // Décrémenter le compteur de chacun des bonus joués																	   
        Object.entries(bonusTab)
            .forEach(([key, value]) => {
                const detail = detailsBonus.get(key);
                if (detail)
                    detail[1] -= value;
            });

        return detailsBonus;
    }

    function getBonusTargeted(bonusTab) {
        const setBonus = bonusList();
    
        const map = new Map(
        Object.entries(bonusTab)
            .map(([key, value]) => {                    
                const detail = setBonus[value.bonus[0]];
                return [key, [...detail, value]];
            })
        );

        return map;
    }

    function formatBonusTitle(bonusTab) {
        const bonusCount = getBonusCountUpdated(bonusTab);

        const remainingBonuses = [...bonusCount.values()]
            .filter(([nom, compteur]) => compteur > 0)
            .map(([nom, compteur]) => `${nom} (${compteur})`)
            .join(' - ');

        const nbBonusDefault = Array.from(bonusDetails().entries()).map(([nom, [description, compteur]]) => compteur).reduce((a, b) => a + b, 0);   
        const bonusDispos = Array.from(bonusCount.entries()).filter(([nom, [description, compteur]]) => compteur > 0);
        let nbBonusDispos = bonusDispos.map(([nom, [description, compteur]]) => compteur).reduce((a, b) => a + b, 0);
    
        return remainingBonuses.length > 0 ? "Bonus disponibles (" + nbBonusDispos + "/" + nbBonusDefault + ") : " + remainingBonuses : "Plus aucun bonus disponible !"
    }

    function contentDisplay() {
        hideLoading();
        document.getElementById('content').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }

    function showError(message = 'Erreur lors du chargement des données. Veuillez réessayer.') {
        hideLoading();
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    // Chargement initial
    fetchLeague().then(() => {
        fetchMatches();
    });

    loadMatches();

    // Gestion du formulaire de sélection de ligue
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('leagueForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('leagueCodeInput'); 
            try {
                loadLeague(input.value)
            }          
            catch(error) {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                const cfgTabButton = document.querySelector('.tab-button[data-tab="cfg"]');
                cfgTabButton.classList.add('active');
                document.getElementById('cfg-tab').classList.add('active');

                console.error('Erreur lors du chargement de la ligue:', error);
                return; // Sortir de la fonction en cas d'erreur
            }

        });
    });

    // Actualisation automatique toutes les heures
    setInterval(fetchMatches, 60 * 60 * 1000);
</script>

</html>